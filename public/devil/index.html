<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Nothing</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<link rel="stylesheet" href="style.css" type="text/css" charset="utf-8" />
<style>
    #divchat {
        bottom: 10px;
        right: 0;
        position: fixed;
        z-index: 1000;
      }
  /* Chat containers */
  .container {
      border: 2px solid #dedede;
      background-color: #f1f1f1;
      border-radius: 5px;
      max-width: 380px;
      padding-left : 5px;
      padding-right: 5px;
      padding-top: 1px;
      padding-bottom: 1px;
      margin: 1px 0;
  }

  /* Darker chat container */
  .darker {
      border-color: #ccc;
      background-color: #ddd;
  }

  /* Clear floats */
  .container::after {
      content: "";
      clear: both;
      display: table;
  }

  /* Style images */
  .container img {
      float: left;
      max-width: 60px;
      width: 100%;
      margin-right: 20px;
      border-radius: 50%;
  }

  /* Style the right image */
  .container img.right {
      float: right;
      margin-left: 20px;
      margin-right:0;
  }

  /* Style time text */
  .time-right {
      float: right;
      color: #aaa;
  }

  /* Style time text */
  .time-left {
      float: left;
      color: #999;
  }

  /* Style msg text */
  .msg-right {
      float: right;
      padding-left: 25px;
  }

  /* Style msg text */
  .msg-left {
      float: left;
      padding-right: 25px;
  }
</style>
</head>
<body>
    <script src="https://www.gstatic.com/firebasejs/3.4.0/firebase.js"></script>
      <script>
        var validated = false;
        var dk = "";
        var dkey1, dkey2, dkey3, kkey1, kkey2, kkey3, gkey;
        var ans1 = false;
        var ans2 = false;

        // Initialize Firebase
        var config = {
          databaseURL: 'https://booming-cosine-188305-1e6db.firebaseio.com'
        };
        firebase.initializeApp(config);

        var msgRef =  firebase.database().ref("mydb/devilchats/msg");
        var allMsgRef =  firebase.database().ref("mydb/devilchats/msg");

        var keyRef =  firebase.database().ref("mydb/devilchats/keys");
        keyRef.orderByKey().on("value", function(snapshot) {
          if(snapshot!=null){
            dkey1 = snapshot.child("dkey1").val();
            dkey2 = snapshot.child("dkey2").val();
            dkey3 = snapshot.child("dkey3").val();
            kkey1 = snapshot.child("kkey1").val();
            kkey2 = snapshot.child("kkey2").val();
            kkey3 = snapshot.child("kkey3").val();
            gkey = snapshot.child("gkey").val();
          }
        });

        function validateFirstAnswer(pAnswer){
          try{
            if(pAnswer===dkey1 || pAnswer===dkey2 || pAnswer===dkey3){
              return "d";
            }
            if(pAnswer===kkey1 || pAnswer===kkey2 || pAnswer===kkey3){
              return "k";
            }
          }catch(err){
            alert(err);
            return "";
          }
          return "";
        }

        function validateSecondAnswer(pAnswer){
          try{
            if(pAnswer===gkey){
              return true;
            }else{
              return false;
            }
          }catch(err){
            return false;
          }
          return false;
        }

        function sendMsg(pMsg){
          try{
            var strTime = new Date().getTime();
            //var strMsg = '{"' + d.getTime() + '":{"dk":"d", "text":"' + pMsg + '"}}' 
            var obj = {"dk":dk, "text":pMsg, "time":strTime};
            msgRef.child(strTime).set(obj);
            retrieveMessages();
          }catch(err){
            alert("error in sendMsg: " + err);
          }
        }

        function retrieveMessages(){
          try{
            allMsgRef.orderByChild("time").on("value", function(snapshot) {
              let parentDiv = document.getElementById('divchat');
              parentDiv.innerHTML="";

              if(snapshot!=null){
                snapshot.forEach(function(child){
                  var key = child.key;
                  var msgDK = snapshot.child(key + "/dk").val();
                  let div = document.createElement('div');
                  if(msgDK===dk){
                    div.className = "container";
                    div.innerHTML = "<span class='msg-right'>" + snapshot.child(key + "/text").val() + "</span>";
                  }else{
                    div.className = "container darker";
                    div.innerHTML = "<span class='msg-left'>" + snapshot.child(key + "/text").val() + "</span>";
                  }

                  parentDiv.appendChild(div);
                });
              }

              let ta = document.createElement('textarea');
              ta.id = "msg";
              ta.rows="3";
              ta.cols = "53";
              ta.placeholder = "type here...";
              ta.setAttribute("onkeypress", "Javascript:doit_onkeypress(event)");
              ta.setAttribute("autofocus", true);

              parentDiv.appendChild(ta);
              document.getElementById("msg").focus();
            }
            );
          }catch(err){
            alert(err);
          }
        }

        function doit_onkeypress(e){
          try{
            var tmpDK = "";
            if (e.keyCode == 13) {  //checks whether the pressed key is "Enter"
              if(!validated){
                if(!ans1){
                  tmpDK = validateFirstAnswer(e.target.value);
                  if(tmpDK==="d" || tmpDK==="k"){
                    ans1 = true;
                    let parentDiv = document.getElementById('divchat');
                    parentDiv.innerHTML="";

                    let div = document.createElement('div');
                    div.className = "container";
                    div.innerHTML = "<span class='msg-right'>" + e.target.value + "</span>";
                    parentDiv.appendChild(div);


                    div = document.createElement('div');
                    div.className = "container darker";
                    div.innerHTML = "<span class='msg-left'>" + "is it ?" + "</span>";
                    parentDiv.appendChild(div);

                    let ta = document.createElement('textarea');
                    ta.id = "msg";
                    ta.rows="3";
                    ta.cols = "53";
                    ta.placeholder = "type here...";
                    ta.setAttribute("onkeypress", "Javascript:doit_onkeypress(event)");
                    ta.autofocus = true;

                    parentDiv.appendChild(ta);
                    document.getElementById("msg").text = "";
                    document.getElementById("msg").focus();

                  }else{
                    sendMsg(e.target.value);
                  }
                }else{
                  if(validateSecondAnswer(e.target.value)){
                    validated = true;
                    dk = tmpDK;
                    retrieveMessages();
                  }else{
                    ans1 = false;
                    sendMsg(e.target.value);
                  }
                }
              }else{
                sendMsg(e.target.value);
              }
              //msg.value = null;
            }
          }catch(err){
            alert(err);
          }
        }
    </script>
  <div id="wrapper">
    <div id="body">
      <div class="i">
        <div id="divchat">
            <!--
            <div class="container">
              <span class="msg-right">Hello. How are you today? ajdhf flhf af;kljjf alkfjal f;aj fa;klfja; ldf;aljf; a;flajfl f;alkfja;lf afjaklf lakdfj f</span>
            </div>
              
            <div class="container darker">
              <span class="msg-left">i'm fine, how about you</span>
            </div>
          -->
          <textarea id="msg" rows="3" cols="53" autofocus placeholder="type here..." onkeypress="Javascript:doit_onkeypress(event)"></textarea>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
